{% extends "./soundcloud.html" %}
{% block headscripts %}
<script type="text/javascript">
	var getMax = function(array) {
		return Math.max.apply(Math,array);
	};
	var getMin = function(array) {
		return Math.min.apply(Math,array);
	};
	var scaleArray = function(omax,omin,nmax,nmin,array) {
		var narray = [];
		var nval;
		for(var i = 0; i < array.length; i++)
		{
			nval = (((array[i]-omin)*(nmax-nmin))/(omax-omin))+nmin;
			narray.push(nval);
		}
		return narray;
	};
	$(function() {
		var $body = $("#gh-body");
		window.canvas = document.createElement("canvas");

		canvas.width = $body.width();
		canvas.height = 100;

		$body.html(canvas);
		
		window.canvasctx = canvas.getContext("2d");
		window.audioctx = new AudioContext();
		window.scriptprocesor = audioctx.createScriptProcessor(2048,1,1);

		scriptprocesor.connect(audioctx.destination);

		window.analyser = audioctx.createAnalyser();
		analyser.smoothingTimeConstant = 0.3;
		analyser.fftSize = 512;

		window.buffersource = audioctx.createBufferSource();
		buffersource.connect(analyser);
		analyser.connect(scriptprocesor);
		buffersource.connect(audioctx.destination);

		scriptprocesor.onaudioprocess = function () {
			var array = new Uint8Array(analyser.frequencyBinCount);
			var omax = getMax(array);
			var omin = getMin(array);
			var nmax = canvas.height;
			var nmin = 0;

			console.log(omax,omin,nmax,nmin);

			array = scaleArray(omax,omin,nmax,nmin,array);

			analyser.getByteFrequencyData(array);

			canvasctx.clearRect(0,0,canvas.width,canvas.height);
			canvasctx.fillStyle="#444";

			var value;

			for(var i = 0; i < array.length; i++)
			{
				value = array[i];
				canvasctx.fillRect(i*5,canvas.height,3,value);
			}
		};
	});
</script>
{% endblock %}
{% block body %}
{% endblock %}